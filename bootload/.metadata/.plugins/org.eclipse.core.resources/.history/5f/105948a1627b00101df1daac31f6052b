/*
 * w25q64.c
 *
 *  Created on: Aug 17, 2025
 *      Author: Administrator
 */

#ifndef USER_W25Q64_C_
#define USER_W25Q64_C_

#include "w25q64.h"


/**
  * @brief SPI1 读一个字节
  * @param None
  * @retval None
  */
uint8_t flash_read_byte(void)
{
    uint8_t t_data = 0, r_data = 0;

    if(HAL_SPI_TransmitReceive(&hspi2, &t_data, &r_data, 1, 0xFFFFFF) != HAL_OK)
    {
        r_data = 0xff;
    }
    return r_data;
}

// 交换一个字节
uint8_t w25q128_spi_swap_byte(uint8_t data)
{
    uint8_t recv_data = 0;
    HAL_SPI_TransmitReceive(&hspi2, &data, &recv_data, 1, HAL_MAX_DELAY);
    return recv_data;
}
/**
  * @brief SPI1 写一个字节
  * @param byte 写入的字节
  * @retval 写状态 0成功 1失败
  */
uint8_t flash_send_byte(uint8_t byte)
{
    uint8_t r_data;

    if(HAL_SPI_TransmitReceive(&hspi2, &byte, &r_data, 1, 0xFFFFFF) != HAL_OK)
    {
      return 1;
    }
    return 0;
}

/**
  * @brief FLASH 写使能
  * @param None
  * @retval None
  */
void flash_write_enable(void)
{
	W25Q64_CS(0);
    flash_send_byte(0x06);
    W25Q64_CS(1);
}

/**
  * @brief FLASH 等待写结束
  * @param None
  * @retval None
  */
void flash_wait_for_write_end(void)
{
  uint8_t state = 0;

  W25Q64_CS(0);

  flash_send_byte(0x05);

  do
  {
      state = flash_read_byte();
  }
  while((state & 0x01) == SET);

  W25Q64_CS(1);
}

/**
  * @brief FLASH 读ID
  * @param None
  * @retval None
  */
uint32_t flash_read_ID(void)
{
  uint32_t temp, temp0, temp1, temp2;

  W25Q64_CS(0);

  flash_send_byte(0x9F);

  temp0 = flash_read_byte();
  temp1 = flash_read_byte();
  temp2 = flash_read_byte();

  W25Q64_CS(1);

  temp = (temp0 << 16) | (temp1 << 8) | temp2;

  return temp;
}

#endif /* USER_W25Q64_C_ */
